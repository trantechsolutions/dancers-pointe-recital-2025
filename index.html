<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Search and explore the Dancer's Pointe Recital program by show or performer. Mobile-friendly design with quick access to favorites and full act details." />
  <title>Dancer's Pointe Recital</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.8/dist/vuetify.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.1.96/css/materialdesignicons.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Roboto, sans-serif;
      margin: 20px;
    }

    .subtitle-wrap {
      white-space: normal !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      display: block !important;
    }

    .favorite-act {
      border: 2px solid palevioletred !important;
      background-color: pink;
    }
  </style>
</head>

<body>
  <div id="app">
    <v-app>
      <v-container>
        <h1 class="text-h4 text-md-h4 text-lg-h4 font-weight-bold text-center mb-4">Dancer's Pointe Recital</h1>

        <v-select label="Select Show" v-model="selectedShow" :items="shows" item-title="label" item-value="value"
          outlined dense></v-select>

        <v-alert type="error" v-if="error">{{ error }}</v-alert>

        <v-divider v-if="selectedShow" class="mb-4"></v-divider>
        <!-- Favorites Accordion -->
        <v-expansion-panels multiple v-if="selectedShow">
          <v-expansion-panel>
            <v-expansion-panel-title>
              My Favorites ({{ favorites.size }})
            </v-expansion-panel-title>
            <v-expansion-panel-text>
              <v-list two-lines>
                <v-list-item v-for="fav in favoriteResults" :key="fav.name">
                  <v-list-item-content>
                    <v-list-item-title class="d-flex justify-space-between align-center">
                      {{ fav.name }}
                      <v-icon color="amber" @click="toggleFavorite(fav.name)" style="cursor: pointer;"
                        title="Remove from favorites">
                        mdi-star
                      </v-icon>
                    </v-list-item-title>

                    <v-list-item-subtitle class="subtitle-wrap">
                      <template v-if="fav.missing">
                        <em class="text-error">Not in this show</em>
                      </template>
                      <template v-else>
                        <span v-for="(act, i) in fav.acts" :key="i">
                          #{{ act.number }} â€” {{ act.title }}<span v-if="i < fav.acts.length - 1"><br /></span>
                        </span>
                      </template>
                    </v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>

                <div v-if="favorites.size === 0">No favorites added yet.</div>
              </v-list>
            </v-expansion-panel-text>
          </v-expansion-panel>
        </v-expansion-panels>

        <div v-touch="onSwipe">
          <!-- PROGRAM VIEW -->
          <div v-if="activeTab === 'program'" class="tab-view">
            <!-- Entire Program Display -->
            <div v-if="showData" class="mt-6">
              <h2>Program</h2>

              <v-card v-for="(act, i) in showData.acts" :key="act.number + i" class="mb-3 pa-3" elevation="1"
                :class="{ 'favorite-act': act.performers.some(p => isFavorite(p)) }">
                <div class="text-sm font-weight-bold">{{ act.number }} - {{ act.title }}</div>
                <div class="text-caption mt-1">
                  <strong>Performers:</strong><br />
                  <span v-for="(name, j) in act.performers" :key="j">
                    {{ name }}<span v-if="j < act.performers.length - 1">, </span>
                  </span>
                </div>
              </v-card>
            </div>
          </div>
          <!-- SEARCH VIEW -->
          <div v-else-if="activeTab === 'search'" class="tab-view">

            <v-text-field label="Search dancer" v-model="search" clearable outlined :loading="loading"
              :disabled="!selectedShow || loading" class="mt-3"></v-text-field>

            <div v-if="search && searchResults.length === 0 && !loading">
              <p>No dancers found matching "{{ search }}"</p>
            </div>

            <v-list two-lines>
              <v-list-item v-for="result in searchResults" :key="result.name">
                <v-list-item-content>
                  <v-list-item-title class="d-flex justify-space-between align-center">
                    {{ result.name }}
                    <v-icon color="amber" @click="toggleFavorite(result.name)" class="ml-2" style="cursor: pointer;">
                      {{ isFavorite(result.name) ? 'mdi-star' : 'mdi-star-outline' }}
                    </v-icon>
                  </v-list-item-title>
                  <v-list-item-subtitle class="subtitle-wrap">
                    <span v-for="(act, i) in result.acts" :key="act.number">
                      #{{ act.number }} â€” {{ act.title }}<span v-if="i < result.acts.length - 1"><br />
                      </span>
                    </span>
                  </v-list-item-subtitle>
                </v-list-item-content>
              </v-list-item>

            </v-list>


          </div>
        </div>
        <v-bottom-navigation v-model="activeTab" color="pink" grow class="mt-8">
          <v-btn value="program" icon>
            <v-icon>mdi-format-list-bulleted</v-icon>
            <span class="text-caption">Program</span>
          </v-btn>
          <v-btn value="search" icon>
            <v-icon>mdi-magnify</v-icon>
            <span class="text-caption">Search</span>
          </v-btn>
        </v-bottom-navigation>


      </v-container>

    </v-app>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.8/dist/vuetify.min.js"></script>
  <script>
    const { createApp, ref, computed, watch } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify();


    createApp({
      setup() {
        const search = ref('');
        const selectedShow = ref('');
        const showData = ref(null);
        const loading = ref(false);
        const error = ref(null);
        const showOnlyFavorites = ref(false);
        const activeTab = ref('program');

        function handleSwipeLeft() {
          if (activeTab.value === 'program') activeTab.value = 'search';
        }

        function handleSwipeRight() {
          if (activeTab.value === 'search') activeTab.value = 'program';
        }


        // Reactive favorites for current show, stored as Set
        const favorites = ref(new Set());

        const shows = [
          { label: "Saturday, June 21 12PM Show", value: "21_12pm" },
          { label: "Saturday, June 21 5PM Show", value: "21_5pm" },
          { label: "Sunday, June 22 12PM Show", value: "22_12pm" },
          { label: "Sunday, June 22 5PM Show", value: "22_5pm" },
        ];

        const searchTableHeaders = [
          { text: 'Dancer Name', value: 'name' },
          { text: 'Acts', value: 'acts' }
        ];

        const programHeaders = [
          { text: 'Act #', value: 'number' },
          { text: 'Title', value: 'title' },
          { text: 'Performers', value: 'performers' }
        ];


        // Load favorites for a given show from localStorage
        function loadFavorites() {
          const stored = localStorage.getItem(`favorites_global`);
          favorites.value = new Set(JSON.parse(stored || '[]'));
        }

        // Save favorites for current show to localStorage
        function saveFavorites() {
          localStorage.setItem(`favorites_global`, JSON.stringify([...favorites.value]));
        }

        // When selectedShow changes: clear search, load show data & favorites
        watch(selectedShow, async (val) => {
          if (!val) {
            showData.value = null;
            favorites.value = new Set();
            search.value = '';
            return;
          }

          showData.value = null;
          search.value = '';
          loading.value = true;
          error.value = null;

          // Load favorites for this show
          loadFavorites();

          try {
            const response = await fetch(`resource/${val}.json`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            showData.value = data;
          } catch (e) {
            error.value = 'Failed to load show data: ' + e.message;
          } finally {
            loading.value = false;
          }
        });

        const searchResults = computed(() => {
          if (!search.value.trim() || !showData.value) return [];
          const q = search.value.toLowerCase();
          const map = {};

          showData.value.acts.forEach(act => {
            act.performers.forEach(name => {
              if (name.toLowerCase().includes(q)) {
                if (!map[name]) map[name] = [];
                map[name].push({ number: act.number, title: act.title });
              }
            });
          });

          let results = Object.entries(map).map(([name, acts]) => ({ name, acts }));

          if (showOnlyFavorites.value) {
            results = results.filter(r => isFavorite(r.name));
          }

          return results;
        });

        const toggleFavorite = (name) => {
          if (!selectedShow.value) return;
          if (favorites.value.has(name)) {
            favorites.value.delete(name);
          } else {
            favorites.value.add(name);
          }
          saveFavorites();
        };

        const isFavorite = (name) => favorites.value.has(name);

        // Compute favorite dancers with acts for current show
        const favoriteResults = computed(() => {
          if (!showData.value) return [];

          const inShowMap = {};
          const allPerformers = new Set();

          // Collect who is in the current show
          showData.value.acts.forEach(act => {
            act.performers.forEach(name => {
              allPerformers.add(name);
              if (!inShowMap[name]) inShowMap[name] = [];
              inShowMap[name].push({ number: act.number, title: act.title });
            });
          });// For each favorite (globally), show info or mark missing
          return [...favorites.value].map(name => {
            if (allPerformers.has(name)) {
              return { name, acts: inShowMap[name], missing: false };
            } else {
              return { name, acts: [], missing: true };
            }
          });
        });

        function onSwipe(direction) {
          if (direction === 'left' && activeTab.value === 'program') {
            activeTab.value = 'search';
          } else if (direction === 'right' && activeTab.value === 'search') {
            activeTab.value = 'program';
          }
        }


        return {
          search,
          selectedShow,
          showData,
          searchResults,
          shows,
          loading,
          error,
          favorites,
          showOnlyFavorites,
          toggleFavorite,
          isFavorite,
          favoriteResults,
          searchTableHeaders,
          programHeaders,
          activeTab,
          onSwipe
        };
      }
    }).use(vuetify).mount('#app');

    // ðŸ‘‡ Register the swipe directive globally
    app.directive('touch', {
      mounted(el, binding) {
        let startX = 0;
        el.addEventListener("touchstart", e => {
          startX = e.changedTouches[0].screenX;
        });
        el.addEventListener("touchend", e => {
          const endX = e.changedTouches[0].screenX;
          const delta = endX - startX;
          if (Math.abs(delta) > 50) {
            const direction = delta > 0 ? 'right' : 'left';
            if (typeof binding.value === 'function') {
              binding.value(direction);
            }
          }
        });
      }
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('js/service-worker.js')
        .then(() => console.log('Service Worker Registered'));
    }
  </script>

</body>

</html>